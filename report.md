# PDF Method Report

## 1.综述

在计算机图形学中，**概率密度函数（Probability Density Function，PDF）**主要用于**随机采样**和**模拟真实世界光照**的过程中。其核心作用包括以下几个方面：

1. 重要性采样
   在路径追踪等光照计算算法中，通过概率密度函数对某些方向或区域进行加权采样，可以优先采集对最终图像贡献较大的样本，从而减少噪声、提高渲染效率。例如，在采样某一光源时，PDF 用于决定哪些方向更可能产生强烈光照。
2. 蒙特卡洛积分
   图形学中的许多积分问题（如全局光照）无法解析计算，需用蒙特卡洛方法近似。PDF 在此过程中定义了采样点的分布规律，使得估计结果更加准确。
3. 材质与散射模型
   在描述材质反射（如 BRDF）或散射（如 BSSRDF）行为时，PDF 被用来建模光线与表面相互作用的概率分布，使模拟结果更贴近现实物理现象。
4. 环境光与光源采样
   在基于图像的照明中，从高动态范围图像（HDR）中采样环境光时，PDF 控制哪些像素（方向）被更频繁采样，优化了光照模拟的性能和质量。

## 2.理论推导和实现方法

#### 2.1 重要性采样

在计算一个难以解析的积分或者难以计算的图形面积/体积时我们常常会使用采样计算的方法，最常规的方法是采用均匀采样，如计算积分时在区间里面均匀取点，计算图形面积的时候在划定的大范围内概率均等地取点等等。

均匀采样的缺点在于：当考察的对象分布没有那么“平滑”，即在某些部位出现小范围的突升突降，锯齿等情况时，均匀取点难以探测到这些小范围的剧烈变化，于是我们引入了重要性采样：在某些“重要的”地方取到点的概率大一些（相应地对于那一部分的还原也就越加真实），另一方面则小一些，对于取到每一个点的相对概率大小在整个空间中就形成了一个概率密度函数（PDF），我们可以通过选取合适的概率密度函数在保证采样数不太多时最高质量地还原原样本，这种方法称为重要性采样。

在图形渲染等应用中，重要性采样相对于常规采样（如均匀采样）具有以下显著优势：

1.降低方差，提高图像质量
重要性采样根据被积函数的形状分配采样概率，即在函数值较大的区域采样更多，从而更有效地捕捉主要贡献。这显著降低了估计结果的方差，使图像更平滑、噪声更少。

2.更快收敛
在蒙特卡洛积分中，重要性采样能用较少的样本达到与普通采样更多样本相同甚至更好的结果，因此提高了计算效率，节省了渲染时间。

3.适用于复杂场景
在真实感渲染中，光照分布、BRDF等函数往往高度非均匀。常规均匀采样无法有效处理这些高频变化区域，而重要性采样则能智能集中资源在关键区域，更好地表现复杂光照效果。

4.避免资源浪费
均匀采样会在贡献小甚至无效的区域浪费样本，而重要性采样将采样资源聚焦在对结果影响更大的部分，使计算更加经济。

#### 2.2 重要性采样的推导

简化问题，假如以 $p(x)$ 的概率在定义在 $[0, 1]$ 上的函数进行取点积分，则有
$$I = \int _{0}^1 f(x) dx = \int _0^1 \dfrac{f(x)}{p(x)}p(x)dx$$
这个式子相当于以 $p(x)$ 的加权概率对函数 $g(x) = \dfrac{f(x)}{p(x)}$进行采样，于是可以转化为这样的求和：
$$ I = \dfrac{1}{N} \sum_ {i = 1}^N \dfrac{f(x_i)}{p(x_i)}, \ \ x_i \sim p(x) $$
可以将上述公式用于计算ray_color( ) 函数中的光源采样。

#### 2.3 光线路径追踪的蒙特卡洛积分

在光线追踪中，我们使用蒙特卡洛积分来估算像素点的出射光照，其原始形式来自 Kajiya 提出的渲染方程：

$$
L_o(\mathbf{x}, \omega_o) = L_e(\mathbf{x}, \omega_o) + \int_{\Omega} f_r(\mathbf{x}, \omega_i, \omega_o) \, L_i(\mathbf{x}, \omega_i) \, (\omega_i \cdot \mathbf{n}) \, d\omega_i
$$

其中：

- $L_o(\mathbf{x}, \omega_o)$：从点 $\mathbf{x}$ 在方向 $\omega_o$ 出射的辐射度
- $L_e(\mathbf{x}, \omega_o)$：自发光项（例如光源）
- $f_r(\mathbf{x}, \omega_i, \omega_o)$：BRDF，描述表面反射特性
- $L_i(\mathbf{x}, \omega_i)$：从方向 $ \omega_i $ 入射的光照
- $\omega_i \cdot \mathbf{n}$：余弦项，考虑角度影响
- $\Omega$：单位半球，所有可能的入射方向

蒙特卡洛积分形式::

用 $N$ 个样本进行近似估计：

$$
L_o(\mathbf{x}, \omega_o) \approx L_e(\mathbf{x}, \omega_o) + \frac{1}{N} \sum_{i=1}^{N} \frac{f_r(\mathbf{x}, \omega_i, \omega_o) \, L_i(\mathbf{x}, \omega_i) \, (\omega_i \cdot \mathbf{n})}{p(\omega_i)}
$$

其中：

- $p(\omega_i)$：采样方向 $\omega_i$ 的概率密度函数（PDF）
- $\omega_i$：从上半球中根据 $p(\omega)$ 采样得到的方向


#### 2.4 漫反射材质的PDF

在 lambertian 类的实现中，根据物理定律，散射光的强度与光线与法线夹角的余弦值成正比，于是在可能反射光线的那个半球内，每个方向被取到的概率密度函数为

$$p(x) = \dfrac{\cos \theta}{\pi}$$
其中$\theta$是光线和法线的夹角。

#### 2.5 对光源采样的PDF

当我们在光源上选取一个小面积元素 $dA$ 进行采样时，其被采样的概率为：

$$
p_q(q) \cdot dA
$$

在单位球面上，若我们考虑一个小的立体角元素 $d\omega$，该方向被采样的概率为：

$$
p(\omega) \cdot d\omega
$$



面积 $dA$ 与立体角 $d\omega$ 之间的几何关系为：

$$
d\omega = \frac{dA \cdot \cos\theta}{\text{distance}^2(p, q)}
$$

其中：
- $\theta$：点 $q$ 到点 $p$ 的方向与法线之间的夹角
- $\text{distance}(p, q)$：两点之间的距离


由于采样事件本质相同（只是换了测度），采样概率应保持一致：

$$
p(\omega) \cdot d\omega = p_q(q) \cdot dA
$$

将上面立体角转换关系代入：

$$
p(\omega) \cdot \frac{dA \cdot \cos\theta}{\text{distance}^2(p, q)} = p_q(q) \cdot dA
$$

两边同时除以 $dA$，得：

$$
p(\omega) = \frac{p_q(q) \cdot \text{distance}^2(p, q)}{\cos\theta}
$$

如果在光源上均匀采样,
假设光源面积为 $A$，则：

$$
p_q(q) = \frac{1}{A}
$$

代入上式：

$$
p(\omega) = \frac{\text{distance}^2(p, q)}{\cos\theta \cdot A}
$$


#### 2.6 混合PDF

在我们实际实现的时候，不会选择单一的采样策略，而是将不同的采样策略通过不同的概率加权形成一个新的采样策略，例如在我的项目的最终代码实现中，选择了以二分之一的概率选择了漫反射材质的余弦加权采样，另外二分之一的概率选择直接对光源进行采样，使得生成的画面更加丰富。

